<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARCHON - Where Art, Value, and Legacy Are Preserved</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background-color: #000;
            color: #fff;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Navigation */
        nav {
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background-color: rgba(0,0,0,0.95);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        nav .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 20px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 0.3em;
            cursor: pointer;
            user-select: none;
        }
        
        .nav-buttons {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 300;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: none;
            color: #fff;
            white-space: nowrap;
        }
        
        .btn:hover:not(:disabled) {
            opacity: 0.8;
        }
        
        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background-color: #fff;
            color: #000;
        }
        
        .btn-secondary {
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .btn-large {
            padding: 16px 40px;
            font-size: 14px;
            min-width: 200px;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }
        
        /* Hero Section */
        .hero {
            min-height: 90vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            overflow: hidden;
            padding: 40px 20px;
        }
        
        .hero-content {
            position: relative;
            z-index: 10;
            max-width: 900px;
        }
        
        h1 {
            font-size: clamp(48px, 8vw, 96px);
            font-weight: 300;
            letter-spacing: 0.2em;
            margin-bottom: 24px;
        }
        
        .hero-subtitle {
            font-size: clamp(18px, 3vw, 24px);
            color: rgba(255,255,255,0.7);
            margin-bottom: 16px;
            font-weight: 300;
        }
        
        .hero-description {
            font-size: 18px;
            color: rgba(255,255,255,0.5);
            max-width: 700px;
            margin: 0 auto 48px;
            line-height: 1.6;
        }
        
        .hero-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(8px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: rgb(9, 9, 11);
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 600px;
            width: 100%;
            position: relative;
            padding: 40px;
            margin: auto;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-close {
            position: absolute;
            top: 24px;
            right: 24px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.4);
            cursor: pointer;
            font-size: 24px;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            z-index: 10;
        }
        
        .modal-close:hover {
            color: #fff;
        }
        
        .modal h2 {
            font-size: 28px;
            font-weight: 300;
            margin-bottom: 8px;
            letter-spacing: 0.05em;
        }
        
        .modal > div > p, .modal-content > p {
            color: rgba(255,255,255,0.5);
            font-size: 14px;
            margin-bottom: 32px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            margin-bottom: 8px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            background-color: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: #fff;
            font-size: 14px;
            font-family: inherit;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: rgba(255,255,255,0.3);
        }
        
        .file-upload {
            border: 2px dashed rgba(255,255,255,0.2);
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload:hover {
            border-color: rgba(255,255,255,0.4);
            background-color: rgba(255,255,255,0.02);
        }
        
        .file-upload.dragging {
            border-color: rgba(255,255,255,0.6);
            background-color: rgba(255,255,255,0.05);
        }
        
        .file-upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .file-preview {
            margin-top: 20px;
            text-align: center;
        }
        
        .file-preview img {
            max-width: 100%;
            max-height: 300px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .vault-type-option {
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            margin-bottom: 16px;
        }
        
        .vault-type-option:hover {
            border-color: rgba(255,255,255,0.2);
        }
        
        .vault-type-option.selected {
            border-color: rgba(255,255,255,0.3);
            background-color: rgba(255,255,255,0.05);
        }
        
        .vault-type-option h3 {
            font-size: 18px;
            font-weight: 300;
            margin-bottom: 8px;
        }
        
        .vault-type-option p {
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            margin: 0;
        }
        
        .alert {
            padding: 12px 16px;
            margin-bottom: 20px;
            border-left: 3px solid;
            font-size: 14px;
        }
        
        .alert-error {
            background-color: rgba(239, 68, 68, 0.1);
            border-color: rgb(239, 68, 68);
            color: rgb(252, 165, 165);
        }
        
        .alert-success {
            background-color: rgba(34, 197, 94, 0.1);
            border-color: rgb(34, 197, 94);
            color: rgb(134, 239, 172);
        }
        
        .alert-info {
            background-color: rgba(59, 130, 246, 0.1);
            border-color: rgb(59, 130, 246);
            color: rgb(147, 197, 253);
        }
        
        /* Vault View */
        .vault {
            display: none;
            min-height: 100vh;
        }
        
        .vault.active {
            display: block;
        }
        
        .vault-header {
            padding: 48px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .vault-header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            flex-wrap: wrap;
            gap: 24px;
        }
        
        .vault-info h2 {
            font-size: 36px;
            font-weight: 300;
            margin-bottom: 8px;
        }
        
        .vault-stats {
            font-size: 14px;
            color: rgba(255,255,255,0.5);
        }
        
        .limit-warning {
            color: rgb(251, 191, 36);
        }
        
        .limit-reached {
            color: rgb(239, 68, 68);
        }
        
        /* Asset Grid */
        .assets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            padding: 48px 0;
        }
        
        .asset-card {
            background-color: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .asset-card:hover {
            border-color: rgba(255,255,255,0.2);
            transform: translateY(-4px);
        }
        
        .asset-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            background-color: rgba(255,255,255,0.05);
        }
        
        .asset-info {
            padding: 20px;
        }
        
        .asset-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .asset-meta {
            font-size: 13px;
            color: rgba(255,255,255,0.5);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 120px 20px;
        }
        
        .empty-state h3 {
            font-size: 24px;
            font-weight: 300;
            margin-bottom: 8px;
            margin-top: 24px;
        }
        
        .empty-state p {
            color: rgba(255,255,255,0.5);
            margin-bottom: 32px;
        }
        
        .success-check {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background-color: rgba(74, 222, 128, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgb(74, 222, 128);
            font-size: 32px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .loading {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: rgba(255,255,255,0.6);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
        }
        
        .uploading-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            flex-direction: column;
            gap: 24px;
        }
        
        .uploading-overlay.active {
            display: flex;
        }
        
        .progress-bar {
            width: 300px;
            height: 4px;
            background-color: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background-color: #fff;
            transition: width 0.3s;
        }
        
        .asset-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        /* Asset Detail View */
        .asset-detail {
            padding: 48px 0;
        }
        
        .asset-detail-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 48px;
        }
        
        @media (max-width: 768px) {
            .asset-detail-content {
                grid-template-columns: 1fr;
            }
        }
        
        .asset-detail-image {
            width: 100%;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .asset-detail-info h2 {
            font-size: 32px;
            font-weight: 300;
            margin-bottom: 24px;
        }
        
        .detail-row {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }
        
        .detail-value {
            font-size: 16px;
            color: rgba(255,255,255,0.9);
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">
            <div class="spinner"></div>
            <p style="color: rgba(255,255,255,0.6);">Loading ARCHON...</p>
        </div>
    </div>

    <div id="uploadingOverlay" class="uploading-overlay">
        <div class="spinner"></div>
        <p style="font-size: 18px;">Uploading asset...</p>
        <div class="progress-bar">
            <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
        </div>
        <p id="uploadStatus" style="font-size: 14px; color: rgba(255,255,255,0.6);"></p>
    </div>

    <script>
        (function() {
            'use strict';
            
            console.log('ARCHON initializing...');

            if (typeof window.supabase === 'undefined') {
                document.getElementById('app').innerHTML = `
                    <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 16px; padding: 20px; text-align: center;">
                        <p style="color: #ef4444; font-size: 18px;">Failed to load required libraries.</p>
                        <p style="color: rgba(255,255,255,0.6); font-size: 14px;">Please refresh the page.</p>
                    </div>
                `;
                return;
            }

            const supabase = window.supabase.createClient(
                'https://jcyoxdtdihgpxsrpfufs.supabase.co',
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpjeW94ZHRkaWhncHhzcnBmdWZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1OTkwNzgsImV4cCI6MjA4NTE3NTA3OH0.D3N3jPf0rRdBuUqkaWMZYEuYYkogbEOaoJZfh8NzHNc'
            );

            let state = {
                user: null,
                profile: null,
                assets: [],
                selectedAsset: null,
                loading: true,
                view: 'landing', // 'landing', 'vault', 'asset-detail'
                signupStep: 1,
                selectedVaultType: null,
                signupData: {},
                uploadData: {}
            };

            async function init() {
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    
                    if (session) {
                        state.user = session.user;
                        await loadUserProfile();
                        await loadAssets();
                        state.view = 'vault';
                    }
                    
                    state.loading = false;
                    render();

                    supabase.auth.onAuthStateChange(async (event, session) => {
                        console.log('Auth state changed:', event);
                        if (session) {
                            state.user = session.user;
                            await loadUserProfile();
                            await loadAssets();
                            state.view = 'vault';
                        } else {
                            state.user = null;
                            state.profile = null;
                            state.assets = [];
                            state.view = 'landing';
                        }
                        render();
                    });
                } catch (error) {
                    console.error('Init error:', error);
                    state.loading = false;
                    render();
                }
            }

            async function loadUserProfile() {
                if (!state.user) return;
                
                try {
                    const { data } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', state.user.id)
                        .single();
                    
                    if (data) {
                        state.profile = data;
                    }
                } catch (error) {
                    console.error('Profile load error:', error);
                }
            }

            async function loadAssets() {
                if (!state.user) return;
                
                try {
                    const { data, error } = await supabase
                        .from('assets')
                        .select('*')
                        .eq('user_id', state.user.id)
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    state.assets = data || [];
                } catch (error) {
                    console.error('Assets load error:', error);
                    state.assets = [];
                }
            }

            // Navigation
            window.showLanding = function() {
                state.view = 'landing';
                render();
            };

            window.showVault = function() {
                if (!state.user) {
                    window.openLogin();
                    return;
                }
                state.view = 'vault';
                render();
            };

            window.showAssetDetail = async function(assetId) {
                const asset = state.assets.find(a => a.id === assetId);
                if (asset) {
                    state.selectedAsset = asset;
                    state.view = 'asset-detail';
                    render();
                }
            };

            // Modals
            window.openSignup = function() {
                state.signupStep = 1;
                state.selectedVaultType = null;
                state.signupData = {};
                document.getElementById('signupModal').classList.add('active');
            };

            window.closeSignup = function() {
                document.getElementById('signupModal').classList.remove('active');
                state.signupStep = 1;
                state.selectedVaultType = null;
            };

            window.openLogin = function() {
                document.getElementById('loginModal').classList.add('active');
            };

            window.closeLogin = function() {
                document.getElementById('loginModal').classList.remove('active');
            };

            window.openUploadModal = function() {
                if (!canUpload()) {
                    alert('You have reached your asset limit. Upgrade to add more assets.');
                    return;
                }
                state.uploadData = {};
                document.getElementById('uploadModal').classList.add('active');
            };

            window.closeUploadModal = function() {
                document.getElementById('uploadModal').classList.remove('active');
                state.uploadData = {};
            };

            function canUpload() {
                if (!state.profile) return false;
                const limit = state.profile.plan_tier === 'starter' ? 5 : 999999;
                return state.profile.asset_count < limit;
            }

            // Auth
            window.handleLogout = async function() {
                try {
                    await supabase.auth.signOut();
                    state.user = null;
                    state.profile = null;
                    state.assets = [];
                    state.view = 'landing';
                    render();
                } catch (error) {
                    console.error('Logout error:', error);
                }
            };

            window.handleSignupStep1 = function(e) {
                e.preventDefault();
                state.signupData = {
                    name: document.getElementById('signupName').value,
                    email: document.getElementById('signupEmail').value,
                    password: document.getElementById('signupPassword').value
                };
                state.signupStep = 2;
                renderSignupContent();
            };

            window.backToSignupStep1 = function() {
                state.signupStep = 1;
                renderSignupContent();
            };

            window.selectVaultType = function(type) {
                state.selectedVaultType = type;
                document.querySelectorAll('.vault-type-option').forEach(opt => {
                    opt.classList.toggle('selected', opt.dataset.type === type);
                });
                document.getElementById('createVaultBtn').disabled = false;
            };

            window.createAccount = async function() {
                const { name, email, password } = state.signupData;
                const errorEl = document.getElementById('signupError');
                
                if (errorEl) errorEl.classList.add('hidden');

                try {
                    const { data: authData, error: authError } = await supabase.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                full_name: name,
                                vault_type: state.selectedVaultType
                            }
                        }
                    });

                    if (authError) throw authError;

                    if (authData.user) {
                        const { error: profileError } = await supabase
                            .from('profiles')
                            .insert([{
                                id: authData.user.id,
                                full_name: name,
                                vault_type: state.selectedVaultType,
                                plan_tier: 'starter',
                                asset_count: 0,
                                storage_used: 0
                            }]);

                        if (profileError && profileError.code !== '23505') {
                            console.error('Profile error:', profileError);
                        }
                    }

                    state.signupStep = 3;
                    renderSignupContent();

                    setTimeout(() => {
                        window.closeSignup();
                        if (authData.session) {
                            state.view = 'vault';
                        }
                        render();
                    }, 3000);

                } catch (error) {
                    console.error('Signup error:', error);
                    if (errorEl) {
                        errorEl.textContent = error.message || 'An error occurred during signup';
                        errorEl.classList.remove('hidden');
                    }
                }
            };

            window.handleLogin = async function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const errorEl = document.getElementById('loginError');
                
                if (errorEl) errorEl.classList.add('hidden');

                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email,
                        password
                    });

                    if (error) throw error;

                    if (data.user && !data.user.email_confirmed_at) {
                        if (errorEl) {
                            errorEl.innerHTML = 'Please check your email to confirm your account.<br><small>Check spam if you don\'t see it.</small>';
                            errorEl.classList.remove('hidden');
                            errorEl.classList.remove('alert-error');
                            errorEl.classList.add('alert-info');
                        }
                        return;
                    }

                    window.closeLogin();
                    await loadUserProfile();
                    await loadAssets();
                    state.view = 'vault';
                    render();

                } catch (error) {
                    console.error('Login error:', error);
                    if (errorEl) {
                        errorEl.textContent = error.message || 'Invalid email or password';
                        errorEl.classList.remove('hidden');
                        errorEl.classList.add('alert-error');
                    }
                }
            };

            window.switchToSignup = function(e) {
                e.preventDefault();
                window.closeLogin();
                window.openSignup();
            };

            // Asset Upload
            window.handleFileSelect = function(e) {
                const file = e.target.files[0];
                if (file) {
                    state.uploadData.file = file;
                    showFilePreview(file);
                }
            };

            window.triggerFileInput = function() {
                document.getElementById('assetFileInput').click();
            };

            function showFilePreview(file) {
                const preview = document.getElementById('filePreview');
                const uploadArea = document.getElementById('fileUploadArea');
                
                const fileType = file.type;
                const fileIcon = getFileIcon(fileType, file.name);
                
                if (fileType.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.innerHTML = `
                            <img src="${e.target.result}" alt="Preview" style="max-width: 100%; max-height: 300px; border: 1px solid rgba(255,255,255,0.1);" />
                            <p style="margin-top: 16px; font-size: 14px; color: rgba(255,255,255,0.6);">${file.name} (${formatBytes(file.size)})</p>
                        `;
                        preview.classList.remove('hidden');
                        uploadArea.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.innerHTML = `
                        <div style="text-align: center; padding: 40px; border: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 64px; margin-bottom: 16px;">${fileIcon}</div>
                            <p style="font-size: 16px; color: rgba(255,255,255,0.9); margin-bottom: 8px;">${file.name}</p>
                            <p style="font-size: 14px; color: rgba(255,255,255,0.5);">${formatBytes(file.size)}</p>
                        </div>
                    `;
                    preview.classList.remove('hidden');
                    uploadArea.style.display = 'none';
                }
            }

            function getFileIcon(mimeType, fileName) {
                if (mimeType.startsWith('image/')) return 'üñºÔ∏è';
                if (mimeType.startsWith('video/')) return 'üé¨';
                if (mimeType === 'application/pdf') return 'üìÑ';
                if (mimeType.includes('word') || fileName.endsWith('.doc') || fileName.endsWith('.docx')) return 'üìù';
                if (mimeType.includes('excel') || mimeType.includes('spreadsheet') || fileName.endsWith('.xls') || fileName.endsWith('.xlsx')) return 'üìä';
                if (mimeType.includes('zip') || mimeType.includes('rar') || mimeType.includes('7z') || fileName.endsWith('.zip') || fileName.endsWith('.rar') || fileName.endsWith('.7z')) return 'üóúÔ∏è';
                if (mimeType.startsWith('audio/')) return 'üéµ';
                if (mimeType.includes('text/')) return 'üìÉ';
                return 'üìé';
            }

            function getFileIconFromUrl(url, mimeType) {
                if (!url) return 'üìÑ';
                const fileName = url.toLowerCase();
                
                // Check if it's an image
                if (fileName.match(/\.(jpg|jpeg|png|gif|webp|svg)$/i)) return null;
                
                // Check by extension
                if (fileName.endsWith('.pdf')) return 'üìÑ';
                if (fileName.match(/\.(doc|docx)$/i)) return 'üìù';
                if (fileName.match(/\.(xls|xlsx|csv)$/i)) return 'üìä';
                if (fileName.match(/\.(zip|rar|7z)$/i)) return 'üóúÔ∏è';
                if (fileName.match(/\.(mp4|mov|avi|webm|mkv)$/i)) return 'üé¨';
                if (fileName.match(/\.(mp3|wav|ogg|m4a)$/i)) return 'üéµ';
                if (fileName.match(/\.(txt|md)$/i)) return 'üìÉ';
                
                return 'üìé';
            }

            window.handleUploadSubmit = async function(e) {
                e.preventDefault();
                
                if (!state.uploadData.file) {
                    alert('Please select a file');
                    return;
                }

                const title = document.getElementById('assetTitle').value;
                const year = document.getElementById('assetYear').value;
                const medium = document.getElementById('assetMedium').value;
                const dimensions = document.getElementById('assetDimensions').value;
                const description = document.getElementById('assetDescription').value;

                try {
                    document.getElementById('uploadingOverlay').classList.add('active');
                    document.getElementById('uploadStatus').textContent = 'Uploading image...';
                    
                    // Upload file to Supabase Storage
                    const fileExt = state.uploadData.file.name.split('.').pop();
                    const fileName = `${state.user.id}/${Date.now()}.${fileExt}`;
                    
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('assets')
                        .upload(fileName, state.uploadData.file);

                    if (uploadError) throw uploadError;

                    // Get public URL
                    const { data: { publicUrl } } = supabase.storage
                        .from('assets')
                        .getPublicUrl(fileName);

                    document.getElementById('uploadStatus').textContent = 'Creating asset record...';
                    document.getElementById('progressBarFill').style.width = '70%';

                    // Create asset record
                    const { data: assetData, error: assetError } = await supabase
                        .from('assets')
                        .insert([{
                            user_id: state.user.id,
                            title,
                            year: year ? parseInt(year) : null,
                            medium,
                            dimensions,
                            description,
                            image_url: publicUrl,
                            file_size: state.uploadData.file.size,
                            metadata: {
                                file_type: state.uploadData.file.type,
                                file_name: state.uploadData.file.name
                            }
                        }])
                        .select()
                        .single();

                    if (assetError) throw assetError;

                    document.getElementById('uploadStatus').textContent = 'Updating profile...';
                    document.getElementById('progressBarFill').style.width = '90%';

                    // Update profile asset count
                    const { error: updateError } = await supabase
                        .from('profiles')
                        .update({ 
                            asset_count: state.profile.asset_count + 1,
                            storage_used: (state.profile.storage_used || 0) + state.uploadData.file.size
                        })
                        .eq('id', state.user.id);

                    if (updateError) throw updateError;

                    document.getElementById('progressBarFill').style.width = '100%';
                    document.getElementById('uploadStatus').textContent = 'Complete!';

                    // Reload data
                    await loadUserProfile();
                    await loadAssets();

                    setTimeout(() => {
                        document.getElementById('uploadingOverlay').classList.remove('active');
                        document.getElementById('progressBarFill').style.width = '0%';
                        window.closeUploadModal();
                        render();
                    }, 500);

                } catch (error) {
                    console.error('Upload error:', error);
                    document.getElementById('uploadingOverlay').classList.remove('active');
                    alert('Upload failed: ' + error.message);
                }
            };

            // Asset Actions
            window.deleteAsset = async function(assetId) {
                if (!confirm('Are you sure you want to delete this asset? This cannot be undone.')) {
                    return;
                }

                try {
                    const asset = state.assets.find(a => a.id === assetId);
                    if (!asset) return;

                    // Delete from storage
                    if (asset.image_url) {
                        const fileName = asset.image_url.split('/').pop();
                        await supabase.storage
                            .from('assets')
                            .remove([`${state.user.id}/${fileName}`]);
                    }

                    // Delete from database
                    const { error } = await supabase
                        .from('assets')
                        .delete()
                        .eq('id', assetId);

                    if (error) throw error;

                    // Update profile
                    await supabase
                        .from('profiles')
                        .update({ 
                            asset_count: Math.max(0, state.profile.asset_count - 1),
                            storage_used: Math.max(0, (state.profile.storage_used || 0) - (asset.file_size || 0))
                        })
                        .eq('id', state.user.id);

                    // Reload
                    await loadUserProfile();
                    await loadAssets();
                    
                    if (state.view === 'asset-detail') {
                        state.view = 'vault';
                    }
                    
                    render();

                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Failed to delete asset: ' + error.message);
                }
            };

            // Render Functions
            function renderSignupContent() {
                const step1 = document.getElementById('signupStep1');
                const step2 = document.getElementById('signupStep2');
                const step3 = document.getElementById('signupStep3');

                if (step1) step1.classList.toggle('active', state.signupStep === 1);
                if (step2) step2.classList.toggle('active', state.signupStep === 2);
                if (step3) step3.classList.toggle('active', state.signupStep === 3);
            }

            function formatBytes(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
            }

            function render() {
                const app = document.getElementById('app');
                
                if (state.loading) {
                    return;
                }

                const isLoggedIn = !!state.user;
                const assetCount = state.profile?.asset_count || 0;
                const assetLimit = state.profile?.plan_tier === 'starter' ? 5 : 999999;
                const canUploadMore = assetCount < assetLimit;

                app.innerHTML = `
                    <nav>
                        <div class="container">
                            <div class="logo" onclick="showLanding()">ARCHON</div>
                            <div class="nav-buttons">
                                ${isLoggedIn ? `
                                    <span style="font-size: 14px; color: rgba(255,255,255,0.5);">${state.user.email}</span>
                                    <button class="btn" onclick="showVault()">My Vault</button>
                                    <button class="btn btn-secondary" onclick="handleLogout()">Sign Out</button>
                                ` : `
                                    <button class="btn" onclick="openLogin()">Sign In</button>
                                    <button class="btn btn-primary" onclick="openSignup()">Start Free</button>
                                `}
                            </div>
                        </div>
                    </nav>

                    ${state.view === 'landing' ? renderLanding() : ''}
                    ${state.view === 'vault' ? renderVault() : ''}
                    ${state.view === 'asset-detail' ? renderAssetDetail() : ''}
                    
                    ${renderModals()}
                `;
            }

            function renderLanding() {
                return `
                    <div class="hero">
                        <div class="hero-content">
                            <img src="https://jcyoxdtdihgpxsrpfufs.supabase.co/storage/v1/object/public/Public/IMG_3936.png" alt="ARCHON Logo" style="max-width: 400px; width: 80%; margin: 0 auto 40px; display: block;" />
                            <h1>ARCHON</h1>
                            <p class="hero-subtitle">Where Art, Value, and Legacy Are Preserved</p>
                            <p class="hero-description">
                                The first digital vault built for creative works and valuable collections.
                                Not social media. Not cloud storage. A permanent, professional record of what matters most.
                            </p>
                            <div class="hero-buttons">
                                <button class="btn btn-primary btn-large" onclick="openSignup()">Start Free ‚Äî 5 Assets</button>
                                <button class="btn btn-secondary btn-large" onclick="alert('Full pricing details coming soon!')">View Pricing</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            function renderVault() {
                const assetCount = state.profile?.asset_count || 0;
                const assetLimit = state.profile?.plan_tier === 'starter' ? 5 : '‚àû';
                const planTier = (state.profile?.plan_tier || 'starter').toUpperCase();
                const vaultTitle = state.profile?.vault_type === 'creator' ? 'Creative Vault' : 'Collection Vault';
                const canUploadMore = assetCount < (state.profile?.plan_tier === 'starter' ? 5 : 999999);
                const isNearLimit = assetCount >= 4 && state.profile?.plan_tier === 'starter';
                const isAtLimit = assetCount >= 5 && state.profile?.plan_tier === 'starter';

                return `
                    <div class="vault active">
                        <section class="vault-header">
                            <div class="container">
                                <div class="vault-header-content">
                                    <div class="vault-info">
                                        <h2>${vaultTitle}</h2>
                                        <p class="vault-stats ${isNearLimit ? 'limit-warning' : ''} ${isAtLimit ? 'limit-reached' : ''}">
                                            ${assetCount} of ${assetLimit} assets ¬∑ ${planTier} Plan
                                            ${isNearLimit && !isAtLimit ? ' ¬∑ Almost full!' : ''}
                                            ${isAtLimit ? ' ¬∑ Limit reached' : ''}
                                        </p>
                                    </div>
                                    <button class="btn btn-primary" onclick="openUploadModal()" ${!canUploadMore ? 'disabled' : ''}>
                                        + NEW ASSET
                                    </button>
                                </div>
                            </div>
                        </section>

                        <section class="container">
                            ${state.assets.length === 0 ? `
                                <div class="empty-state">
                                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="color: rgba(255,255,255,0.2); margin: 0 auto;">
                                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                    </svg>
                                    <h3>Your vault is empty</h3>
                                    <p>Upload your first asset to get started</p>
                                    <button class="btn btn-primary" onclick="openUploadModal()">UPLOAD FIRST ASSET</button>
                                </div>
                            ` : `
                                <div class="assets-grid">
                                    ${state.assets.map(asset => {
                                        const fileIcon = asset.image_url && (
                                            asset.image_url.match(/\.(jpg|jpeg|png|gif|webp|svg)$/i) ||
                                            asset.metadata?.file_type?.startsWith('image/')
                                        ) ? null : getFileIconFromUrl(asset.image_url, asset.metadata?.file_type);
                                        
                                        return `
                                        <div class="asset-card" onclick="showAssetDetail('${asset.id}')">
                                            ${asset.image_url && !fileIcon ? `
                                                <img src="${asset.image_url}" alt="${asset.title}" class="asset-image" />
                                            ` : `
                                                <div class="asset-image" style="display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05);">
                                                    <span style="font-size: 64px; opacity: 0.5;">${fileIcon || 'üìÑ'}</span>
                                                </div>
                                            `}
                                            <div class="asset-info">
                                                <div class="asset-title">${asset.title}</div>
                                                <div class="asset-meta">
                                                    ${asset.year ? asset.year : ''} 
                                                    ${asset.year && asset.medium ? '¬∑' : ''} 
                                                    ${asset.medium || ''}
                                                    ${asset.file_size ? (asset.medium || asset.year ? ' ¬∑ ' : '') + formatBytes(asset.file_size) : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `}).join('')}
                                </div>
                            `}
                        </section>
                    </div>
                `;
            }

            function renderAssetDetail() {
                if (!state.selectedAsset) return '';

                const asset = state.selectedAsset;
                const fileIcon = getFileIconFromUrl(asset.image_url, asset.metadata?.file_type);
                const isImage = !fileIcon && asset.image_url;
                
                return `
                    <div class="asset-detail">
                        <div class="container">
                            <button class="btn btn-secondary btn-small" onclick="showVault()" style="margin-bottom: 32px;">
                                ‚Üê Back to Vault
                            </button>
                            
                            <div class="asset-detail-content">
                                <div>
                                    ${isImage ? `
                                        <img src="${asset.image_url}" alt="${asset.title}" class="asset-detail-image" />
                                    ` : `
                                        <div class="asset-detail-image" style="aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.05);">
                                            <span style="font-size: 96px; opacity: 0.3; margin-bottom: 24px;">${fileIcon || 'üìÑ'}</span>
                                            ${asset.image_url ? `
                                                <a href="${asset.image_url}" download="${asset.metadata?.file_name || asset.title}" class="btn btn-primary" style="text-decoration: none;">
                                                    Download File
                                                </a>
                                            ` : ''}
                                        </div>
                                    `}
                                </div>
                                
                                <div class="asset-detail-info">
                                    <h2>${asset.title}</h2>
                                    
                                    ${asset.metadata?.file_name ? `
                                        <div class="detail-row">
                                            <div class="detail-label">File Name</div>
                                            <div class="detail-value">${asset.metadata.file_name}</div>
                                        </div>
                                    ` : ''}
                                    
                                    ${asset.year ? `
                                        <div class="detail-row">
                                            <div class="detail-label">Year</div>
                                            <div class="detail-value">${asset.year}</div>
                                        </div>
                                    ` : ''}
                                    
                                    ${asset.medium ? `
                                        <div class="detail-row">
                                            <div class="detail-label">Medium</div>
                                            <div class="detail-value">${asset.medium}</div>
                                        </div>
                                    ` : ''}
                                    
                                    ${asset.dimensions ? `
                                        <div class="detail-row">
                                            <div class="detail-label">Dimensions</div>
                                            <div class="detail-value">${asset.dimensions}</div>
                                        </div>
                                    ` : ''}
                                    
                                    ${asset.description ? `
                                        <div class="detail-row">
                                            <div class="detail-label">Description</div>
                                            <div class="detail-value">${asset.description}</div>
                                        </div>
                                    ` : ''}
                                    
                                    ${asset.file_size ? `
                                        <div class="detail-row">
                                            <div class="detail-label">File Size</div>
                                            <div class="detail-value">${formatBytes(asset.file_size)}</div>
                                        </div>
                                    ` : ''}
                                    
                                    ${asset.metadata?.file_type ? `
                                        <div class="detail-row">
                                            <div class="detail-label">File Type</div>
                                            <div class="detail-value">${asset.metadata.file_type}</div>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="detail-row">
                                        <div class="detail-label">Added</div>
                                        <div class="detail-value">${new Date(asset.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                                    </div>
                                    
                                    <div style="margin-top: 32px; padding-top: 32px; border-top: 1px solid rgba(255,255,255,0.1);">
                                        ${asset.image_url && !isImage ? `
                                            <a href="${asset.image_url}" download="${asset.metadata?.file_name || asset.title}" class="btn btn-primary" style="width: 100%; text-decoration: none; display: block; text-align: center; margin-bottom: 12px;">
                                                Download File
                                            </a>
                                        ` : ''}
                                        <button class="btn btn-secondary" onclick="deleteAsset('${asset.id}')" style="width: 100%;">
                                            Delete Asset
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            function renderModals() {
                return `
                    <!-- Signup Modal -->
                    <div id="signupModal" class="modal">
                        <div class="modal-content">
                            <button class="modal-close" onclick="closeSignup()">√ó</button>
                            
                            <div id="signupStep1" class="step active">
                                <h2>Create Your Account</h2>
                                <p>Start preserving your assets today. Free forever.</p>
                                
                                <div id="signupError" class="alert alert-error hidden"></div>
                                
                                <form onsubmit="handleSignupStep1(event)">
                                    <div class="form-group">
                                        <label>Full Name</label>
                                        <input type="text" id="signupName" required placeholder="John Doe">
                                    </div>
                                    <div class="form-group">
                                        <label>Email Address</label>
                                        <input type="email" id="signupEmail" required placeholder="john@example.com">
                                    </div>
                                    <div class="form-group">
                                        <label>Password</label>
                                        <input type="password" id="signupPassword" required minlength="8" placeholder="Minimum 8 characters">
                                    </div>
                                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 8px;">Continue</button>
                                </form>
                            </div>

                            <div id="signupStep2" class="step">
                                <h2>Choose Your Vault Type</h2>
                                <p>This helps us customize your experience.</p>
                                
                                <div class="vault-type-option" data-type="creator" onclick="selectVaultType('creator')">
                                    <h3>Creator Vault</h3>
                                    <p>For artists, photographers, designers documenting their work.</p>
                                </div>
                                <div class="vault-type-option" data-type="collector" onclick="selectVaultType('collector')">
                                    <h3>Collector Vault</h3>
                                    <p>For collectors of art, watches, wine, and valuable assets.</p>
                                </div>
                                
                                <button id="createVaultBtn" class="btn btn-primary" style="width: 100%;" disabled onclick="createAccount()">Create My Vault</button>
                                <button class="btn btn-secondary" style="width: 100%; margin-top: 12px;" onclick="backToSignupStep1()">Back</button>
                            </div>

                            <div id="signupStep3" class="step">
                                <div class="success-check">‚úì</div>
                                <h2 style="text-align: center;">Welcome to ARCHON</h2>
                                <p style="text-align: center;">Your vault is ready. Redirecting...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Login Modal -->
                    <div id="loginModal" class="modal">
                        <div class="modal-content">
                            <button class="modal-close" onclick="closeLogin()">√ó</button>
                            
                            <h2>Welcome Back</h2>
                            <p>Sign in to access your vault.</p>
                            
                            <div id="loginError" class="alert alert-error hidden"></div>
                            
                            <form onsubmit="handleLogin(event)">
                                <div class="form-group">
                                    <label>Email Address</label>
                                    <input type="email" id="loginEmail" required placeholder="john@example.com">
                                </div>
                                <div class="form-group">
                                    <label>Password</label>
                                    <input type="password" id="loginPassword" required placeholder="Enter your password">
                                </div>
                                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 8px;">Sign In</button>
                                <p style="text-align: center; font-size: 14px; color: rgba(255,255,255,0.5); margin-top: 16px;">
                                    Don't have an account? 
                                    <a href="#" onclick="switchToSignup(event)" style="color: #fff; text-decoration: underline; cursor: pointer;">Sign up free</a>
                                </p>
                            </form>
                        </div>
                    </div>

                    <!-- Upload Modal -->
                    <div id="uploadModal" class="modal">
                        <div class="modal-content">
                            <button class="modal-close" onclick="closeUploadModal()">√ó</button>
                            
                            <h2>Add New Asset</h2>
                            <p>Upload and document your valuable asset.</p>
                            
                            <form onsubmit="handleUploadSubmit(event)">
                                <div class="form-group">
                                    <label>File</label>
                                    <input type="file" id="assetFileInput" accept="*/*" onchange="handleFileSelect(event)" style="display: none;" />
                                    <div id="fileUploadArea" class="file-upload" onclick="triggerFileInput()">
                                        <div class="file-upload-icon">üìé</div>
                                        <p style="color: rgba(255,255,255,0.7); margin-bottom: 8px;">Click to upload file</p>
                                        <p style="color: rgba(255,255,255,0.4); font-size: 12px;">Images, PDFs, Documents, Videos, Archives up to 50MB</p>
                                    </div>
                                    <div id="filePreview" class="file-preview hidden"></div>
                                </div>

                                <div class="form-group">
                                    <label>Title *</label>
                                    <input type="text" id="assetTitle" required placeholder="e.g., Sunset Over Mountains">
                                </div>
                                
                                <div class="form-group">
                                    <label>Year</label>
                                    <input type="number" id="assetYear" min="1800" max="2100" placeholder="e.g., 2024">
                                </div>
                                
                                <div class="form-group">
                                    <label>Medium</label>
                                    <input type="text" id="assetMedium" placeholder="e.g., Oil on Canvas, Digital Photography">
                                </div>
                                
                                <div class="form-group">
                                    <label>Dimensions</label>
                                    <input type="text" id="assetDimensions" placeholder="e.g., 24 x 36 inches">
                                </div>
                                
                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea id="assetDescription" placeholder="Tell the story of this piece..."></textarea>
                                </div>
                                
                                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 8px;">Upload Asset</button>
                            </form>
                        </div>
                    </div>
                `;
            }

            init();
            console.log('ARCHON initialized successfully');
        })();
    </script>
</body>
</html>
